#!/usr/bin/env bash
# waypoint-cli - Command-line interface for Waypoint snapshot management
# This is a thin wrapper around D-Bus calls to waypoint-helper

set -euo pipefail

DBUS_SERVICE="tech.geektoshi.waypoint"
DBUS_PATH="/tech/geektoshi/waypoint"
DBUS_INTERFACE="tech.geektoshi.waypoint.Helper"

usage() {
    cat << EOF
Waypoint CLI - Btrfs snapshot management for Void Linux

Usage:
    waypoint-cli create <name> [description] [subvolumes]
    waypoint-cli list
    waypoint-cli delete <name>
    waypoint-cli restore <name>
    waypoint-cli cleanup [--schedule-based]
    waypoint-cli help

Commands:
    create      Create a new snapshot
    list        List all snapshots
    delete      Delete a snapshot
    restore     Restore a snapshot (rollback system)
    cleanup     Apply retention policy to delete old snapshots
    help        Show this help message

Arguments for create:
    name        Name for the snapshot (required)
    description Human-readable description (optional)
    subvolumes  Comma-separated list of mount points to snapshot (optional, defaults to /)
                Example: "/,/home" to snapshot both root and home

Examples:
    waypoint-cli create "before-upgrade" "Snapshot before system upgrade"
    waypoint-cli create "test-$(date +%Y%m%d)" "Daily backup" "/,/home"
    waypoint-cli create "root-only" "Only root filesystem" "/"
    waypoint-cli list
    waypoint-cli delete "old-snapshot"
    waypoint-cli restore "before-upgrade"
    waypoint-cli cleanup --schedule-based

Note: All operations require authentication via Polkit.
EOF
    exit 0
}

check_dbus_service() {
    if ! busctl status "$DBUS_SERVICE" >/dev/null 2>&1; then
        echo "Error: Waypoint D-Bus service is not available." >&2
        echo "Make sure waypoint is installed and D-Bus is running." >&2
        exit 1
    fi
}

validate_snapshot_name() {
    local name="$1"

    # Check if empty
    if [[ -z "$name" ]]; then
        echo "Error: Snapshot name cannot be empty" >&2
        return 1
    fi

    # Check length (max 255 characters)
    if [[ ${#name} -gt 255 ]]; then
        echo "Error: Snapshot name too long (max 255 characters)" >&2
        return 1
    fi

    # Check for forbidden characters and patterns
    if [[ "$name" == *"/"* ]]; then
        echo "Error: Snapshot name cannot contain '/'" >&2
        return 1
    fi

    if [[ "$name" == *".."* ]]; then
        echo "Error: Snapshot name cannot contain '..'" >&2
        return 1
    fi

    # Check if starts with - or .
    if [[ "$name" == -* ]]; then
        echo "Error: Snapshot name cannot start with '-'" >&2
        return 1
    fi

    if [[ "$name" == .* ]]; then
        echo "Error: Snapshot name cannot start with '.'" >&2
        return 1
    fi

    # Check for special names
    if [[ "$name" == "." || "$name" == ".." ]]; then
        echo "Error: Snapshot name cannot be '.' or '..'" >&2
        return 1
    fi

    return 0
}

cmd_create() {
    local name="${1:-}"
    local description="${2:-Snapshot created via CLI}"
    local subvolumes_arg="${3:-/}"

    if [[ -z "$name" ]]; then
        echo "Error: Snapshot name is required" >&2
        echo "Usage: waypoint-cli create <name> [description] [subvolumes]" >&2
        exit 1
    fi

    # Validate snapshot name
    if ! validate_snapshot_name "$name"; then
        echo "Usage: waypoint-cli create <name> [description] [subvolumes]" >&2
        exit 1
    fi

    echo "Creating snapshot: $name"
    echo "Description: $description"

    # Parse subvolumes (comma-separated or single value)
    IFS=',' read -ra subvolumes_array <<< "$subvolumes_arg"
    local subvolume_count=${#subvolumes_array[@]}

    echo "Subvolumes: ${subvolumes_array[*]}"

    # Convert subvolumes to array format for D-Bus
    # The D-Bus method signature is CreateSnapshot(sas) - string, string, array of strings
    local result
    result=$(busctl call --system \
        "$DBUS_SERVICE" \
        "$DBUS_PATH" \
        "$DBUS_INTERFACE" \
        CreateSnapshot \
        'ssas' \
        "$name" \
        "$description" \
        "$subvolume_count" \
        "${subvolumes_array[@]}" 2>&1)

    # Parse result (format: "bs" true "message")
    if echo "$result" | grep -q "true"; then
        echo "✓ Success: $(echo "$result" | sed 's/^bs true s "//' | sed 's/"$//')"
    else
        echo "✗ Failed: $(echo "$result" | sed 's/^bs false s "//' | sed 's/"$//')" >&2
        exit 1
    fi
}

cmd_list() {
    echo "Fetching snapshot list..."
    local result
    result=$(busctl call --system \
        "$DBUS_SERVICE" \
        "$DBUS_PATH" \
        "$DBUS_INTERFACE" \
        ListSnapshots 2>&1)

    # Parse JSON result (format: "s" "json_data")
    local json
    json=$(echo "$result" | sed 's/^s "//' | sed 's/"$//')

    if command -v jq >/dev/null 2>&1; then
        # Pretty print with jq if available
        echo "$json" | jq -r '.[] | "[\(.name)] \(.timestamp) - \(.description // "No description")"'
    else
        # Fallback: just print raw JSON
        echo "$json" | python3 -m json.tool 2>/dev/null || echo "$json"
    fi
}

cmd_delete() {
    local name="${1:-}"

    if [[ -z "$name" ]]; then
        echo "Error: Snapshot name is required" >&2
        echo "Usage: waypoint-cli delete <name>" >&2
        exit 1
    fi

    if ! validate_snapshot_name "$name"; then
        echo "Error: Invalid snapshot name" >&2
        exit 1
    fi

    echo "Deleting snapshot: $name"
    read -p "Are you sure? [y/N] " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Cancelled."
        exit 0
    fi

    local result
    result=$(busctl call --system \
        "$DBUS_SERVICE" \
        "$DBUS_PATH" \
        "$DBUS_INTERFACE" \
        DeleteSnapshot \
        's' \
        "$name" 2>&1)

    if echo "$result" | grep -q "true"; then
        echo "✓ Success: $(echo "$result" | sed 's/^bs true s "//' | sed 's/"$//')"
    else
        echo "✗ Failed: $(echo "$result" | sed 's/^bs false s "//' | sed 's/"$//')" >&2
        exit 1
    fi
}

cmd_restore() {
    local name="${1:-}"

    if [[ -z "$name" ]]; then
        echo "Error: Snapshot name is required" >&2
        echo "Usage: waypoint-cli restore <name>" >&2
        exit 1
    fi

    if ! validate_snapshot_name "$name"; then
        echo "Error: Invalid snapshot name" >&2
        exit 1
    fi

    echo "WARNING: This will restore your system to snapshot: $name"
    echo "You MUST reboot after this operation for changes to take effect."
    echo
    read -p "Are you absolutely sure? [y/N] " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Cancelled."
        exit 0
    fi

    echo "Restoring snapshot: $name"
    local result
    result=$(busctl call --system \
        "$DBUS_SERVICE" \
        "$DBUS_PATH" \
        "$DBUS_INTERFACE" \
        RestoreSnapshot \
        's' \
        "$name" 2>&1)

    if echo "$result" | grep -q "true"; then
        echo "✓ Success: $(echo "$result" | sed 's/^bs true s "//' | sed 's/"$//')"
        echo
        echo "IMPORTANT: You MUST reboot now for changes to take effect!"
        echo "Run: sudo reboot"
    else
        echo "✗ Failed: $(echo "$result" | sed 's/^bs false s "//' | sed 's/"$//')" >&2
        exit 1
    fi
}

cmd_cleanup() {
    local schedule_based=false
    local target="${1:-}"

    if [[ -n "$target" && "$target" != "--schedule-based" ]]; then
        if ! validate_snapshot_name "$target"; then
            echo "Error: Invalid snapshot name for cleanup target" >&2
            exit 1
        fi
    fi

    # Parse flags
    if [[ "${1:-}" == "--schedule-based" ]]; then
        schedule_based=true
    fi

    echo "Running snapshot cleanup..."
    if [[ "$schedule_based" == true ]]; then
        echo "Using per-schedule retention policies from schedules.toml"
    else
        echo "Using legacy global retention policy"
    fi

    local result
    result=$(busctl call --system \
        "$DBUS_SERVICE" \
        "$DBUS_PATH" \
        "$DBUS_INTERFACE" \
        CleanupSnapshots \
        'b' \
        "$schedule_based" 2>&1)

    if echo "$result" | grep -q "true"; then
        echo "✓ Success: $(echo "$result" | sed 's/^bs true s "//' | sed 's/"$//')"
    else
        echo "✗ Failed: $(echo "$result" | sed 's/^bs false s "//' | sed 's/"$//')" >&2
        exit 1
    fi
}

# Main
if [[ $# -eq 0 ]]; then
    usage
fi

COMMAND="$1"
shift

case "$COMMAND" in
    create)
        check_dbus_service
        cmd_create "$@"
        ;;
    list|ls)
        check_dbus_service
        cmd_list "$@"
        ;;
    delete|del|rm)
        check_dbus_service
        cmd_delete "$@"
        ;;
    restore|rollback)
        check_dbus_service
        cmd_restore "$@"
        ;;
    cleanup)
        check_dbus_service
        cmd_cleanup "$@"
        ;;
    help|--help|-h)
        usage
        ;;
    *)
        echo "Error: Unknown command: $COMMAND" >&2
        echo "Run 'waypoint-cli help' for usage information." >&2
        exit 1
        ;;
esac
